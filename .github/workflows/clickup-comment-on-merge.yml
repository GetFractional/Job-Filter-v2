name: Comment on ClickUp when PR merged

on:
  pull_request:
    types: [closed]

jobs:
  comment:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Extract ClickUp task ID from PR body
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const m = body.match(/https:\/\/app\.clickup\.com\/t\/([a-zA-Z0-9-]+)/);
            if (!m) core.setFailed("No ClickUp URL found in PR body.");
            core.setOutput("taskId", m[1]);

      - name: Post comment to ClickUp
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_TEAM_ID: ${{ secrets.CLICKUP_TEAM_ID }}
          TASK_ID: ${{ steps.extract.outputs.taskId }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
        run: |
          set -euo pipefail
          payload_file="$(mktemp)"
          response_file="$(mktemp)"
          cat > "$payload_file" <<EOF
          {
            "comment_text": "Merged PR: ${PR_URL}\nMerge SHA: ${MERGE_SHA}"
          }
          EOF
          if ! curl --fail-with-body --silent --show-error --globoff \
            -X POST "https://api.clickup.com/api/v2/task/${TASK_ID}/comment?team_id=${CLICKUP_TEAM_ID}" \
            -H "Authorization: ${CLICKUP_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @"$payload_file" \
            --output "$response_file"; then
            echo "ClickUp API request failed. Response body:"
            cat "$response_file"
            exit 1
          fi
          echo "ClickUp API response:"
          cat "$response_file"
